<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	    <meta name="description" content="Demo project with jQuery">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">	
<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
		<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
		<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
		<!-- Latest compiled and minified JS -->
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>	
		<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.6/handlebars.min.js" integrity="sha256-1O3BtOwnPyyRzOszK6P+gqaRoXHV6JXj8HkjZmPYhCI=" crossorigin="anonymous"></script>
		<script>
			(function(w,d,s,g,js,fs){
			  g=w.gapi||(w.gapi={});g.analytics={q:[],ready:function(f){this.q.push(f);}};
			  js=d.createElement(s);fs=d.getElementsByTagName(s)[0];
			  js.src='https://apis.google.com/js/platform.js';
			  fs.parentNode.insertBefore(js,fs);js.onload=function(){g.load('analytics');};
			}(window,document,'script'));
		</script>

		<script src="date-range-selector.js"></script>
		<script src="active-users.js"></script>


		<style type="text/css">
			h3.section-header {
				padding: 10px;
			}

			p.internal-footer {
				margin: 1em auto;
				width: 80%;

			}

			#radio-wrap {
				float:left;
				margin: 10px;


			}
			#story-traffic-title {
				display: block;
				
				margin-right: 15px;
			}

			.DateRangeSelector-item {
				float:left;
				margin: 10px;
			}

			#traffic-totals>h5, #traffic-totals>span, #traffic-totals>h4 {
				display: block;
				float:left;
				margin: 5px;
			}


			#traffic-totals>h4 {
				margin-bottom:5px;
			}


		</style>
	</head>
	<body>
		<div class="container">
			<div id="embed-api-auth-container"></div>
			<div class="row">
				<div class="col-sm-6">
					<label for="reporterFilter">Select Reporter</label>
					<select name="reporterName" id="reporterFilter" class="form-control">
						<option value=# selected>Pick Reporter</option>
						<option value="tayer@yakimaherald.com">Tammy Ayer</option>
						<option value="kbain@yakimaherald.com">Kaitlin Bain</option>
						<option value="pferolito@yakimaherald.com">Phil Ferolito</option>					
						<option value="maihoang@yakimaherald.com">Mai Hoang</option>
						<option value="miracheta@yakimaherald.com">Michelle Iracheta</option>
						<option value="dmeyers@yakimaherald.com">Donald Meyers</option>
						<option value="mmorey@yakimaherald.com">Mark Morey</option>
						<option value="moliver@yakimaherald.com">Miles Oliver</option>						
						<option value="pmuir@yakimaherald.com">Patrick Muir</option>
						<option value="mrobsach@yakimaherald.com">Molly Robsach</option>


					</select>
				</div>
				<div class="col-sm-6 col-xs-12">
					<div id="date-range-selector"></div>
				
				</div>
				<div class="col-sm-4 col-sm-offset-4">
					<a class="btn btn-primary" role="button" href="#" id="go-button">GO</a>

				</div>

			</div>

			<div class="row">

				

				<div class="col-sm-6 col-xs-12" id="traffic-totals">
					<h4>Total Traffic</h4>
					<h5>Uniques: </h5><span id="totalUnique" class="trafficTotal">0</span>
					<h5>Pageviews: </h5><span id="totalPages" class="trafficTotal">0</span>
					<h5>Avg Time: </h5><span id="totalAveTime" class="trafficTotal">0</span>
				</div>

			</div>

			<div class="row">


			
				<div class="col-sm-6">
					<h4 id="story-traffic-title">Article Traffic</h4>
					
					<div id="todayTraffic"></div>
					<p class="text-center internal-footer bg-primary">Click a title to see referral sources for that article.</p>
				</div>
			
				<div class="col-sm-6">

					<h4 id="referral-traffic-title">Referral Sources</h4>
					<div id="todayReferral"></div>

					
					

				</div>
		</div><!--end row -->

		<div class="row">
			
			
			
			<h3 class="section-header bg-primary">Past Month</h3>

			<div id='radio-wrap-monthly text-center'>
						<label class="radio-inline">
							<input group='monthMetric' type='radio' name='monthMetric' id='radioMonthUnique' value="ga:uniquePageviews" checked>Uniques
						</label>
						<label class="radio-inline">
							<input group='monthMetric' type='radio' name='monthMetric' id='radioMonthPageview' value='ga:pageviews'>Pageviews
						</label>
						<label class="radio-inline">
							<input group='monthMetric' type='radio' name='monthMetric' id='radioMonthTime' value='ga:avgTimeOnPage'>Time on Page
						</label>
			</div>

			<div class="col-md-10 col-md-offset-1">
				<div id='monthlyChart'>


				</div>

			</div>


		</div>

		<div class="row">

			<h3 class="section-header bg-primary">Past Year</h3>

			<div id='radio-wrap-year text-center'>
						<label class="radio-inline">
							<input group='yearMetric' type='radio' name='yearMetric' id='radioyearUnique' value="ga:uniquePageviews" checked>Uniques
						</label>
						<label class="radio-inline">
							<input group='yearMetric' type='radio' name='yearMetric' id='radioyearPageview' value='ga:pageviews'>Pageviews
						</label>
						<label class="radio-inline">
							<input group='yearMetric' type='radio' name='yearMetric' id='radioyearTime' value='ga:avgTimeOnPage'>Time on Page
						</label>
			</div>

			<div class="col-md-10 col-md-offset-1">
				<div id='annualChart'>


				</div>

			</div>


		</div>




	</body>

	<script id="daily-table" type="text/x-handlebars-template">
		<div class="table-responsive">
			<table class="table table-condensed">
				<thead>
					<tr>
						<th>Article</th>
						<th>Uniques</th>
						<th>Pageviews</th>
						<th>Ave Time</th>
					</tr>
				</thead>
				<tbody>
				{{#each this}}
					<tr>
						<th>{{title}}</th>
						<th>{{uniques}}</th>
						<th>{{pageviews}}</th>
						<th>{{avetime}}</th>
					</tr>
				{{/each}}

				</tbody>
			</table>
		</div>




	</script>
	


	<script type="text/javascript">
		gapi.analytics.ready(function() {

			var dashNS = {
				userFilter: null,
				dateRange: {'start-date': 'yesterday', 'end-date': 'today'},


			};


			gapi.analytics.auth.authorize({
			    container: 'embed-api-auth-container',
			    clientid: '358104014451-02duldjjicu85olvisf18jcm6t297oj7.apps.googleusercontent.com'
			  });

			


			$( '#reporterFilter' ).on('change', function(){
				 dashNS.userFilter = $("#reporterFilter").val();
  			})

		
			var dateRangeSelector = new gapi.analytics.ext.DateRangeSelector({
				container: 'date-range-selector'
			})
				.set(dashNS.dateRange)
				.execute();
				
			dateRangeSelector.on('change', function(data){dashNS.dateRange = data;});

			$("#go-button").click(function(){
				$(this).toggleClass('disabled')
				fireDaily(dashNS.userFilter, dashNS.dateRange['start-date'], dashNS.dateRange['end-date']);
				fireMonthly(dashNS.userFilter)
			})



  			function fireDaily(reporter, dateStart, dateEnd){
  				
  				$('#todayTraffic').html(loadingIcon)


  				var rawTraffic = new gapi.analytics.report.Data({
	  				query: {
	  					ids: 'ga:60921314',
	  					metrics: 'ga:uniquePageviews, ga:pageviews, ga:avgTimeOnPage',
	  					'start-date': dateStart,
	  					'end-date': dateEnd,
	  					dimensions: 'ga:dimension2',
	  					filters: 'ga:dimension1=@' + reporter,
	  					sort: '-ga:uniquePageviews'
	  				}
  				})
  					rawTraffic.on('success', function(response){
  						$("#go-button").toggleClass('disabled');
  						console.log(response)
  						console.log(response.rows)
  						var totals, u, p, t, s, tvs=[], articles;

  						totals = response['totalsForAllResults'];
  						u = totals['ga:uniquePageviews'];
  						p = totals['ga:pageviews'];
  						t = totals['ga:avgTimeOnPage']
  						s = toHHMMSS(t)

  						$( '#totalUnique' ).html(u)
		  				$( '#totalPages').html(p)
		  				$( '#totalAveTime').html(s)

		  				var stories = []

		  				response.rows.forEach(function(row){
		  					article = {title:row[0], uniques:row[1], pageviews:row[2], avetime: toHHMMSS(row[3])}
		  					console.log(article)
		  					stories.push(article)
		  				})

		  				console.log(stories)



		  				var source = $("#daily-table").html();
		  				var template = Handlebars.compile(source);
		  				var html = template(stories);

		  				$('#todayTraffic').html(html);
  					})
  				rawTraffic.execute();
  			};


			
  			var dailyViewRowClickListener;

  			/*dailyViews.on('success', function(response){
  				console.log(response, response.chart)
  				var dailyViewChart = response.chart;
  				var dailyViewDataTable = response.dataTable;

  				dailyViewRowClickListener = google.visualization.events.addListener(dailyViewChart, 'select', function(event){

  					if (!dailyViewChart.getSelection().length) {
  						var options = {
  							query: {
  								filters: 'ga:dimension1=@' + userFilter
  								}
  							}
  						var headingTitle = 'Referral Sources'
  						}

  					else {
  						var row = dailyViewChart.getSelection()[0].row;
	  					var rawTitle = dailyViewDataTable.getValue(row, 0);
	  					var storyTitle = rawTitle.replace(/,/, '\\,')
	  					var shortTitle = storyTitle.split('|')[0]
	  					var options = {
	  						query: {
	  							filters: 'ga:dimension2==' + storyTitle
	  						}
	  					};
	  					var headingTitle = 'Referral Sources - ' + shortTitle
  					};

  					
  					dailyRefer.set(options).execute();
  					$( '#referral-traffic-title' ).text(headingTitle);

  				})/*end listner & function

  			}) end 'dailyViews on success'*/ 


  			


  			$( 'input[name=monthMetric]' ).change(function(){
				var metricMonthPicked = $( 'input[name=monthMetric]:checked' ).val();
				var sortMonthMetric = '-' + metricMonthPicked;
				var chartTitle = titleHash[metricMonthPicked];
				monthlyMetrics.set({query: {metrics: metricMonthPicked, sort: sortMonthMetric}});
				monthlyMetrics.set({chart: {options: {title: chartTitle}}});
				monthlyMetrics.execute();
			})




  		function fireMonthly(reporter){
  			var monthlyMetrics = new gapi.analytics.googleCharts.DataChart({
				  	query: {
						
						ids: 'ga:60921314',
				  		metrics: 'ga:uniquePageviews',
				  		dimensions: 'ga:date', 'start-date': '30daysAgo', 'end-date': 'today',
				  		filters: 'ga:dimension1=@' + dashNS.userFilter
				  	},
				  	chart: {
				  		container: 'monthlyChart',
				  		type: 'COLUMN',
				  		options: {
				  			width: '80%',
				  			title: 'Unique Page Views'

				  		}
				  	}
				 });

  			monthlyMetrics.execute();
  		};


  		

		})/*end ready function for GAPI*/

		var loadingIcon = '<i class="fa fa-cog fa-spin fa-5x fa-fw"></i>'


		var toHHMMSS = function (seconds) {
				var sec = Math.round(seconds)
			    var sec_num = parseInt(sec, 10); // don't forget the second param
			    var hours   = Math.floor(sec_num / 3600);
			    var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
			    var seconds = sec_num - (hours * 3600) - (minutes * 60);

			    if (hours   < 10) {hours   = "0"+hours;}
			    if (minutes < 10) {minutes = "0"+minutes;}
			    if (seconds < 10) {seconds = "0"+seconds;}
			    return hours+':'+minutes+':'+seconds;
			};

	</script>
</html>