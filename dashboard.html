<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	    <meta name="description" content="YHR Analytics Dashboard">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">	
<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
		<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
		<script
  src="https://code.jquery.com/jquery-2.2.4.js"
  integrity="sha256-iT6Q9iMJYuQiMWNd9lDyBUStIq/8PuOW33aOqmvFpqI="
  crossorigin="anonymous"></script>
		<!-- Latest compiled and minified JS -->
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>	
		<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.6/handlebars.min.js" integrity="sha256-1O3BtOwnPyyRzOszK6P+gqaRoXHV6JXj8HkjZmPYhCI=" crossorigin="anonymous"></script>
		<script>
			(function(w,d,s,g,js,fs){
			  g=w.gapi||(w.gapi={});g.analytics={q:[],ready:function(f){this.q.push(f);}};
			  js=d.createElement(s);fs=d.getElementsByTagName(s)[0];
			  js.src='https://apis.google.com/js/platform.js';
			  fs.parentNode.insertBefore(js,fs);js.onload=function(){g.load('analytics');};
			}(window,document,'script'));
		</script>

		<script src="date-range-selector.js"></script>
		<script src="active-users.js"></script>


		<style type="text/css">
			h3.section-header {
				padding: 10px;
			}

			p.internal-footer {
				margin: 1em auto;
				width: 80%;

			}

			#radio-wrap {
				float:left;
				margin: 10px;


			}
			#story-traffic-title {
				display: block;
				
				margin-right: 15px;
			}

			.DateRangeSelector-item {
				float:left;
				margin: 10px;
			}

			#traffic-totals>h3 {
			
				margin: 5px;
			}

			th.traffic-totals {
				font-size: 2em;
				font-weight:bold;
			}
			

			.section-title {
				border-bottom: 1px solid #333333;
			}

			div#todayTraffic, div#todayReferral {
				min-height:200px;
			}

			#reporterFilter {
				margin: 9px;
			}
			#control-group {
				padding: 10px;
				background-color: #e8e8e8;
				border-radius: 10px;
				
			}


		</style>
	</head>
	<body>
		<div class="container">
			<div id="embed-api-auth-container"></div>
			<div class="row">
				<div class="col-sm-6" id="control-group">
					<div class="col-sm-12">
						<select name="reporterName" id="reporterFilter" class="form-control">
							<option value=# selected>Pick Reporter</option>
							<option value="tayer@yakimaherald.com">Tammy Ayer</option>
							<option value="kbain@yakimaherald.com">Kaitlin Bain</option>
							<option value="pferolito@yakimaherald.com">Phil Ferolito</option>					
							<option value="maihoang@yakimaherald.com">Mai Hoang</option>
							<option value="miracheta@yakimaherald.com">Michelle Iracheta</option>
							<option value="dmeyers@yakimaherald.com">Donald Meyers</option>
							<option value="mmorey@yakimaherald.com">Mark Morey</option>
							<option value="moliver@yakimaherald.com">Miles Oliver</option>						
							<option value="pmuir@yakimaherald.com">Patrick Muir</option>
							<option value="mrosbach@yakimaherald.com">Molly Rosbach</option>
						</select>
					</div>
					<div class="col-sm-12">
						<div id="date-range-selector"></div>
					</div>
					<div class="col-sm-12">
						<button class="btn btn-primary btn-block" id="go-button">GO</button>
					</div>
				</div>
				<div class="col-sm-6 col-xs-12" id="traffic-totals">
					<h3 class="section-header">Total Traffic for Period</h3>
					<table class="table table-condensed">
						<thead>
							<tr>
								<th>Uniques</th>
								<th>Pageviews</th>
								<th>Avg Time</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<th id="totalUnique" class="traffic-totals"></th>
								<th id="totalPages" class="traffic-totals"></th>
								<th id="totalAveTime" class="traffic-totals"></th>
							</tr>
						</tbody>
					</table>

					
				</div>
			</div>

			

			<div class="row">

				<div class="col-sm-6">
					<h4 id="story-traffic-title" class="section-title">Article Traffic</h4>
					
					<div id="todayTraffic">
						
					</div>


				</div>
			
				<div class="col-sm-6">

					<h4 id="referral-traffic-title" class="section-title">Referral Sources</h4>
					<div id="todayReferral"></div>

				</div>
			</div><!--end row -->

		<div class="row">
			<div id="timeDateTraffic">
			</div>

		</div>

		<div class="row">
			
			<h3 class="section-header bg-primary">Past Month</h3>

			<div id='radio-wrap-monthly text-center'>
						<label class="radio-inline">
							<input group='monthMetric' type='radio' name='monthMetric' id='radioMonthUnique' value="ga:uniquePageviews" checked>Uniques
						</label>
						<label class="radio-inline">
							<input group='monthMetric' type='radio' name='monthMetric' id='radioMonthPageview' value='ga:pageviews'>Pageviews
						</label>
						<label class="radio-inline">
							<input group='monthMetric' type='radio' name='monthMetric' id='radioMonthTime' value='ga:avgTimeOnPage'>Time on Page
						</label>
			</div>

			<div class="col-md-10 col-md-offset-1">
				<div id='monthlyChart'>

				</div>

			</div>
		</div>

		




	</body>

	<script id="daily-table" type="text/x-handlebars-template">
		<div class="table-responsive">
			<table class="table table-condensed table-striped table-hover">
				<thead>
					<tr>
						<th>Article</th>
						<th>Uniques</th>
						<th>Pageviews</th>
						<th>Ave Time</th>
					</tr>
				</thead>
				<tbody>
				{{#each this}}
					<tr>
						<th class="hed">{{title}}</th>
						<th>{{uniques}}</th>
						<th>{{pageviews}}</th>
						<th>{{avetime}}</th>
					</tr>
				{{/each}}

				</tbody>
			</table>
		</div>




	</script>
	


	<script type="text/javascript">
		gapi.analytics.ready(function() {

			var dashNS = {
				userFilter: null,
				dateRange: {'start-date': 'yesterday', 'end-date': 'today'},
			};


			gapi.analytics.auth.authorize({
			    container: 'embed-api-auth-container',
			    clientid: '358104014451-02duldjjicu85olvisf18jcm6t297oj7.apps.googleusercontent.com'
			  });

			


			$( '#reporterFilter' ).on('change', function(){
				 dashNS.userFilter = $("#reporterFilter").val();
  			})

		
			var dateRangeSelector = new gapi.analytics.ext.DateRangeSelector({
				container: 'date-range-selector'
			})
				.set(dashNS.dateRange)
				.execute();
				
			dateRangeSelector.on('change', function(data){dashNS.dateRange = data;});

			$("#go-button").click(function(){
				$(this).toggleClass('disabled')
				fireDaily(dashNS.userFilter, dashNS.dateRange['start-date'], dashNS.dateRange['end-date']);
				fireRefers(dashNS.userFilter, dashNS.dateRange['start-date'], dashNS.dateRange['end-date']);
				fireMonthly(dashNS.userFilter)
				fireHourly(dashNS.userFilter, dashNS.dateRange['start-date'], dashNS.dateRange['end-date']);
			})



  			function fireDaily(reporter, dateStart, dateEnd, storyHed){
  				
  				$('#todayTraffic').html(loadingIcon)

  				var rawTraffic = new gapi.analytics.report.Data({
	  				query: {
	  					ids: 'ga:60921314',
	  					metrics: 'ga:uniquePageviews, ga:pageviews, ga:avgTimeOnPage',
	  					'start-date': dateStart,
	  					'end-date': dateEnd,
	  					dimensions: 'ga:dimension2',
	  					filters: 'ga:dimension1=@' + reporter,
	  					sort: '-ga:uniquePageviews'
	  				}
  				})

  				if (typeof storyHed != 'undefined'){
  					rawTraffic.set({query: {filters: 'ga:dimension2=@' + storyHed}})
  				}

  				rawTraffic.on('success', function(response){
  						$("#go-button").toggleClass('disabled');
  						var totals, u, p, t, s, tvs=[], articles;

  						totals = response['totalsForAllResults'];
  						u = totals['ga:uniquePageviews'];
  						p = totals['ga:pageviews'];
  						t = totals['ga:avgTimeOnPage']
  						s = toHHMMSS(t)

  						$( '#totalUnique' ).html(u)
		  				$( '#totalPages').html(p)
		  				$( '#totalAveTime').html(s)

		  				var stories = []
		  				var tales = response.rows.slice(0,14)
		  				tales.forEach(function(row){
		  					article = {title:row[0], uniques:row[1], pageviews:row[2], avetime: toHHMMSS(row[3])}
		  					stories.push(article)
		  				})

		  				var source = $("#daily-table").html();
		  				var template = Handlebars.compile(source);
		  				var html = template(stories);

		  				$('#todayTraffic').html(html);
		  				var heds = $('#todayTraffic th.hed')
		  				if (storyHed === undefined){
		  					$('#todayTraffic tbody').one( "click", "th.hed", function(){
		  							var storyHed = $( this ).text()
					                fireDaily(reporter, dashNS.dateRange['start-date'], dashNS.dateRange['end-date'], storyHed)
					                fireRefers(reporter, dashNS.dateRange['start-date'], dashNS.dateRange['end-date'], storyHed)
					                fireHourly(reporter, dashNS.dateRange['start-date'], dashNS.dateRange['end-date'], storyHed)
					                $("#go-button").toggleClass('disabled');
		  					})
		  				} else 
		  					{ $('#todayTraffic tbody').on("click", "th.hed", function(){
		  								var storyHed = undefined;
					                  fireDaily(dashNS.userFilter, dashNS.dateRange['start-date'], dashNS.dateRange['end-date'])
					                  fireRefers(dashNS.userFilter, dashNS.dateRange['start-date'], dashNS.dateRange['end-date'])
					                  fireHourly(dashNS.userFilter, dashNS.dateRange['start-date'], dashNS.dateRange['end-date'])
					                  $("#go-button").toggleClass('disabled');

					                })
		  					}
		  				



  					})

  				rawTraffic.execute();
  			};

  			function fireRefers(reporter, dateStart, dateEnd, storyHed){
  				

  				var dailyRefer = new gapi.analytics.googleCharts.DataChart({

  						query: {
  								ids: 'ga:60921314',
  								metrics: 'ga:uniquePageviews, ga:pageviews',
  								dimensions: 'ga:source',
  								'start-date': dateStart,
  								'end-date': dateEnd,
  								sort: '-ga:uniquePageviews',
  								filters: 'ga:dimension1=@' + reporter,
  								'max-results': '15'

  						},
  						chart: {
  							type: 'TABLE',
  							container: 'todayReferral',
  							options: {
  								width: '100%'

  							}
  						}
  					})

  				if (typeof storyHed != 'undefined'){
  					dailyRefer.set({query: {filters: 'ga:dimension2=@' + storyHed}})
  				}


  				dailyRefer.execute();
  			};


			
  			
  			function fireHourly(reporter, dateStart, dateEnd, storyHed){
  				var hourlyMetrics = new gapi.analytics.googleCharts.DataChart({
  					query: {
  						ids: 'ga:60921314',
  						metrics: 'ga:uniquePageviews, ga:pageviews',
  						dimensions: 'ga:dateHour',
  						'start-date': dateStart,
  						'end-date': dateEnd,
  						filters: 'ga:dimension1=@' + reporter


  					},
  					chart: {
  						container: 'timeDateTraffic',
  						type: 'COLUMN',
  						options: {
  							width: '80%'
  						}
  					}
  				})

  				if (typeof storyHed != 'undefined'){
  					hourlyMetrics.set({query: {filters: 'ga:dimension2=@' + storyHed}})
  				}

  				

  				var s = $('div.DateRangeSelector div.DateRangeSelector-item:last-child input').attr('min')
  				var e = $('div.DateRangeSelector div.DateRangeSelector-item:first-child input').attr('max')
  				var sd = new Date(s)
  				var ed = new Date(e)
  				var d = ed - sd

  				console.log(e, ed)
  				console.log(s, sd)
  				console.log(d)

  				if (d > 86400000){
  					hourlyMetrics.set({query: {dimensions: 'ga:day'}});
  				} else {
  					hourlyMetrics.set({query: {dimensions: 'ga:dateHour'}})
  				}

  				hourlyMetrics.execute();
  				

  			};


  			


  			$( 'input[name=monthMetric]' ).change(function(){
				var metricMonthPicked = $( 'input[name=monthMetric]:checked' ).val();
				var sortMonthMetric = '-' + metricMonthPicked;
				var chartTitle = titleHash[metricMonthPicked];
				monthlyMetrics.set({query: {metrics: metricMonthPicked, sort: sortMonthMetric}});
				monthlyMetrics.set({chart: {options: {title: chartTitle}}});
				monthlyMetrics.execute();
			})




  		function fireMonthly(reporter){
  			var monthlyMetrics = new gapi.analytics.googleCharts.DataChart({
				  	query: {
						
						ids: 'ga:60921314',
				  		metrics: 'ga:uniquePageviews',
				  		dimensions: 'ga:date', 'start-date': '30daysAgo', 'end-date': 'today',
				  		filters: 'ga:dimension1=@' + dashNS.userFilter
				  	},
				  	chart: {
				  		container: 'monthlyChart',
				  		type: 'COLUMN',
				  		options: {
				  			width: '80%',
				  			title: 'Unique Page Views'

				  		}
				  	}
				 });

  			monthlyMetrics.execute();
  		};


  		

		})/*end ready function for GAPI*/

		var loadingIcon = '<i class="fa fa-cog fa-spin fa-5x fa-fw"></i>'


		var toHHMMSS = function (seconds) {
				var sec = Math.round(seconds)
			    var sec_num = parseInt(sec, 10); // don't forget the second param
			    var hours   = Math.floor(sec_num / 3600);
			    var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
			    var seconds = sec_num - (hours * 3600) - (minutes * 60);

			    if (hours   < 10) {hours   = "0"+hours;}
			    if (minutes < 10) {minutes = "0"+minutes;}
			    if (seconds < 10) {seconds = "0"+seconds;}
			    return hours+':'+minutes+':'+seconds;
			};

	</script>
</html>